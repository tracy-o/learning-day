# Test Results: WebCore page caching

## Context

WebCore Pres Layer pages now return public cache-control header. This enables pages to be cached in Belfrage. The tests described in this report verify Belfrage caching performance for WebCore pages.

## Hypotheses

- WebCore returns public cache-control header
- WebCore pages are cached in Belfrage local and distributed (fallback) caches
- Belfrage serving mostly cached content and is performant

## Setup
- Vegeta Runner on EC2
- Requests to Belfrage

## Tests

Request a Topics sport page: https://www.belfrage.test.api.bbc.co.uk/sport/curling, verify `cache-control` header is present and page is cached by checking (looking up) Belfrage local cache (ETS) and distributed (S3) stores.

Run `180s 200rps` test on the same page, verify Belfrage mostly serves cached content using Grafana `local.fresh.hit` cache metric.

## Results

The Topics curling page returns the following public cache-control response header:

```json
{
  "name": "cache-control",
  "value": "public, stale-while-revalidate=0, max-age=30"
}
```

The page can be found in Belfrage in-memory cache through Elixir remote console using the page hash key:

```
iex(belfrage@10.114.165.38)> [{_, _, _, _, {%{body: gzip}, _}}] = :ets.lookup :cache, "c690a8d2f08b1d7832f168f79218165b"
[
  {:entry, "c690a8d2f08b1d7832f168f79218165b", 1587133101502, 21600000,
   {%Belfrage.Struct.Response{
      body: <<31, 139, 8, 0, 0, 0, 0, 0, 0, 3, 237, 125, 235, 154, 219, 54, 178,
        224, 255, 121, 10, 142, 178, 39, 182, 103, 69, 53, 239, 23, 57, 246, 25,
        187, 109, 199, 222, 181, 19, 79, 236, 56, ...>>,
      cache_directive: %{
        cacheability: "public",
        max_age: 30,
        stale_if_error: 0,
        stale_while_revalidate: 0
      },
      fallback: false,
      headers: %{
        "content-encoding" => "gzip",
        ..
      },
      http_status: 200
    }, 1587133101502}}
]
```
```
iex(belfrage@10.114.165.38)36> gzip |> :zlib.gunzip |> String.slice(0..239)
"<!DOCTYPE html><html lang=\"en\" class=\"no-js\"><head><meta charSet=\"utf-8\" /><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" /><title>Curling | BBC Sport</title><meta name=\"description\" content=\"The home of Curling on BBC " <> ...
```

The same page was also cached in Belfrage distributed cache as verified through the cache table and corresponding S3 cache bucket:

```
iex(belfrage_ccp@10.114.163.5)8> BelfrageCcp.cache_info "c690a8d2f08b1d7832f168f79218165b"
{1587139990215, 3835}
```

#### 180s, 200rps
