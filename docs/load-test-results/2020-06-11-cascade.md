# Test results: cascade service

## Context
[Belfrage cascade service](https://paper.dropbox.com/doc/RFC-Fetching-from-multiple-origins-in-Belfrage--A1smYy64nIKHazG~4du2p0RGAg-73EMI4UwT9rMW5hVUpRuc) provides routing for multiple origins that share a route pattern. This report describes the load tests that aim to gauge Belfrage performance when requests are cascaded to multiple downstream origins.

## Hypotheses

- Cascade service is performant at higher request rates: 400rps
- Cascade service introduces latency penalty to downstream origins

## Setup

- Vegeta Runner on EC2: c5.2xlarge instance, 16GB
- Requests to Belfrage on playground: c5.2xlarge, CPUs: 8 vCPUs, 16GB
- OriginSimulator on EC2: c5.2xlarge instance, CPUs: 8 vCPUs
- Build: [Cascade branch](https://github.com/bbc/belfrage/tree/cascade) (e22cb63feeb324d1a0e1d732f0a8d74cbe5dd145) 

## Tests

Run 60s 400rps multiple-latency load tests on the following test route involving two origins backed by OriginSimulator:

```ex
handle "/_private/belfrage-cascade-test", using: ["Origin1", "Origin2"], only_on: "test", examples: ["/_private/belfrage-cascade-test"]
```

Mocking multiple origins with route specs o different platoforms:

```ex
defmodule Routes.Specs.Origin1 do
  def specs do
    %{
      platform: Fabl,
      pipeline: ["CircuitBreaker"],
      query_params_allowlist: ["alternativeJsLoading", "batch"]
    }
  end
end
```

```ex
defmodule Routes.Specs.Origin2 do
  def specs do
    %{
      platform: Mozart,
      pipeline: ["CircuitBreaker"],
      query_params_allowlist: ["alternativeJsLoading", "batch"]
    }
  end
end
```

To divert request traffics from the origins to OriginSimulator, set the corresponding endpoint environment variables of the platforms before building Belfrage:

```
$ export FABL_ENDPOINT=http://..origin_simulator_endpoint..
$ export MOZART_ENDPOINT=http://..origin_simulator_endpoint..
```

Set OriginSimulator to return status 404. This triggers successive, i.e. cascading requests to the origins (OriginSimulator). The following origin latencies were set during the load tests:

- 100ms
- 500ms
- 1s

## Results
